#!/bin/bash
# Usage:
#   ./manage_observers.sh start  <env>
#   ./manage_observers.sh stop   <env>
#   ./manage_observers.sh status <env>
#   ./manage_observers.sh list

set -o errexit
set -o nounset
set -o pipefail

export ORACLE_HOME=${ORACLE_HOME:-/u01/app/oracle/client}
export PATH=$PATH:$ORACLE_HOME/bin
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-}:$ORACLE_HOME/lib:$ORACLE_HOME
cur_host="$(hostname -f)"
cur_host_short="$(hostname -s)"

usage() {
  cat >&2 <<'EOF'
Usage:
  manage_observers.sh start  <env>
  manage_observers.sh stop   <env>
  manage_observers.sh status <env>
  manage_observers.sh list
  manage_observers.sh help
EOF
}

action="${1:-}"
env="${2:-}"

# check args from start/stop/status
case "${action,,}" in
  start|stop|status)
    [[ -n "$env" ]] || { usage; exit 1; }
    ;;
  list)
    [[ -z "${2:-}" ]] || { echo "Too many arguments for 'list'." >&2; usage; exit 1; }
    ;;
  help|-h|--help)
    usage; exit 0
    ;;
  *)
    usage; exit 1
    ;;
esac

prepare_env() {
  local env_in="$1"

  # master host rule
  if [[ "$cur_host" =~ obs[0-9] ]]; then
        master="$(sed -E 's/(obs)[0-9]/\13/' <<<"$cur_host")"
  else
        master="$cur_host"
  fi

  envfile="$HOME/env${env_in}.sh"
  if [[ ! -f "$envfile" ]]; then
        echo "[Error] Env file not found: $envfile" >&2
        exit 2
  fi

  # extract OBSCONFIG (no source yet)
  obsconfig="$(awk -F= '
    $0 ~ /^[[:space:]]*(export[[:space:]]+)?OBSCONFIG[[:space:]]*=/ {
      sub(/^[^=]*=/,"",$0)
      gsub(/^["'\''"]|["'\''"]$/,"",$0)
      print $0; exit
    }
  ' "$envfile")"

  if [[ -z "${obsconfig:-}" ]]; then
        echo "[Error] OBSCONFIG not found in $envfile" >&2
        exit 3
  fi
  if [[ ! -f "$obsconfig" ]]; then
        echo "[Error] OBSCONFIG file not found: $obsconfig" >&2
        exit 4
  fi

  # extract GROUP_NAME from obsconfig
  group_name="$(awk '
    {
      if (match($0, /\(GROUP[[:space:]]*=\(NAME=([^)]+)/, m)) {
        print m[1]; exit
      }
    }
  ' "$obsconfig")"

  if [[ -z "${group_name:-}" ]]; then
        echo "[Error] GROUP_NAME not found in $obsconfig" >&2
        exit 5
  fi

  log="${group_name}_${cur_host_short}_service.log"
  logts() { printf '%s\n' "[Info] $(date +'%Y-%m-%d-%T') $*" >> "$log"; }
  logerr() { printf '%s\n' "[Error] $(date +'%Y-%m-%d-%T') $*" >> "$log"; }

  # define sleeps
  if [[ "${env_in,,}" == *obs* ]]; then
    l_sleep=15
    s_sleep=7
  else
    l_sleep=15
    s_sleep=7
  fi

  # source env
  . "$envfile"
}

# run dgmgrl with logging
run_dgmgrl() {
  "$ORACLE_HOME/bin/dgmgrl" -echo <<EOF >> "$log" 2>&1
SET OBSERVERCONFIGFILE=$obsconfig
$(
  cat
)
EXIT;
EOF
}

# run dgmgrl w/o logging
run_dgmgrl_stdout() {
  "$ORACLE_HOME/bin/dgmgrl" -echo <<EOF
SET OBSERVERCONFIGFILE=$obsconfig
$(
  cat
)
EXIT;
EOF
}

# start observers
start_observer() {
  prepare_env "$env"
  logts "Using OBSCONFIG=$obsconfig, GROUP_NAME=$group_name"
  logts "Starting observer on $cur_host"
  run_dgmgrl <<EOF
START OBSERVING $group_name
EOF

  sleep "$l_sleep"

  logts "Setting master observer to $master"
  run_dgmgrl <<EOF
SET MASTEROBSERVERHOSTS FOR $group_name TO $master
EOF

  sleep "$s_sleep"

  logts "Show observers..."
  run_dgmgrl <<'EOF'
SHOW OBSERVERS
EOF
}

# stop observers
stop_observer() {
  prepare_env "$env"
  logts "Trying to stop observer on $cur_host..."
  run_dgmgrl <<EOF
STOP OBSERVING $group_name
EOF

  sleep "$s_sleep"

  logts "Show observers after STOP..."
  run_dgmgrl <<'EOF'
SHOW OBSERVERS
EOF
}

# status observer
status_observer() {
  prepare_env "$env"
  echo "[Info] $(date +'%Y-%m-%d-%T') Showing observers (status)..."
  run_dgmgrl_stdout <<'EOF'
SHOW OBSERVERS
EOF
}

list_envs() {
  shopt -s nullglob
  local files=( "$HOME"/env*.sh )
  if ((${#files[@]} == 0)); then
        echo "No environment files found in $HOME (looking for env*.sh)"
        shopt -u nullglob
        return 0
  fi
  IFS=$'\n' files=($(printf '%s\n' "${files[@]}" | sort)); unset IFS
  echo "Available environments:"
  for f in "${files[@]}"; do
        local base envname
        base="$(basename -- "$f")"
         envname="${base#env}"
        envname="${envname%.sh}"
        printf '  %-20s %s/%s\n' "$envname" "$HOME" "$base"
  done
  shopt -u nullglob
}


case "${action,,}" in
  start)  start_observer ;;
  stop)   stop_observer  ;;
  status) status_observer ;;
  list)   list_envs      ;;
  *) echo "Unknown action: $action (use: start|stop|status|list)" >&2; exit 10 ;;
esac
